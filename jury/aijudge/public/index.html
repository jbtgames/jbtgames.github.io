<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Judge ‚Ä¢ Moral Court</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.16/variable.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-950 text-slate-100">
  <main class="max-w-5xl mx-auto px-4 py-10 space-y-12">
    <header class="text-center space-y-4">
      <span class="badge">Hourly AI Trials</span>
      <h1 class="text-4xl font-semibold tracking-tight">AI Judge ‚Äî Moral Court</h1>
      <p class="text-slate-300 max-w-2xl mx-auto">
        Upload dilemmas, debate with the crowd, then let our AI tribunal deliver a nightly verdict.
      </p>
      <div class="flex flex-wrap justify-center gap-3 text-sm text-slate-400">
        <span>üöÄ Upload cases</span>
        <span>üí¨ Sentiment-weighted comments</span>
        <span>‚öñÔ∏è AI prosecution, defense &amp; judge</span>
      </div>
    </header>

    <section class="grid gap-6 md:grid-cols-[2fr,1fr]">
      <article class="card space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold">Live Docket</h2>
            <button id="run-trial" class="button-secondary text-sm">Run AI Trial</button>
          </div>
          <a href="judges.html" class="text-sm text-indigo-300 hover:text-indigo-200">Meet the Judges ‚Üí</a>
        </div>
        <p id="trial-message" class="text-xs text-indigo-200" hidden></p>
        <div id="case-feed" class="space-y-4"></div>
      </article>

      <aside class="card space-y-4">
        <h2 class="text-xl font-semibold">Submit a Case</h2>
        <form id="upload-form" class="space-y-3">
          <div>
            <label class="block text-sm text-slate-300 mb-1">Title</label>
            <input type="text" name="title" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 focus:border-indigo-400" placeholder="Caught lying to a friend" />
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">Story</label>
            <textarea name="story" rows="5" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 focus:border-indigo-400" placeholder="Explain what happened"></textarea>
          </div>
          <button type="submit" class="button-primary w-full">Send to the Jury</button>
          <p class="text-xs text-slate-400">
            Uploads run through a quick moderation check before joining the docket.
          </p>
        </form>
      </aside>
    </section>

    <section class="card space-y-4">
      <h2 class="text-xl font-semibold">How the Court Works</h2>
      <div class="grid md:grid-cols-3 gap-4 text-sm text-slate-300">
        <div>
          <h3 class="font-semibold text-slate-100 mb-2">Daytime Debate</h3>
          <p>People vote and leave comments. A sentiment bot keeps score and builds the crowd summary.</p>
        </div>
        <div>
          <h3 class="font-semibold text-slate-100 mb-2">Hourly Session</h3>
          <p>Top cases face prosecution, defense, and a neutral judge prompt. Verdicts land automatically.</p>
        </div>
        <div>
          <h3 class="font-semibold text-slate-100 mb-2">Transparency</h3>
          <p>Every verdict includes public mood, AI arguments, and judge confidence.</p>
        </div>
      </div>
    </section>
  </main>

  <template id="case-template">
    <article class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
      <header class="space-y-1">
        <div class="flex items-center justify-between gap-4">
          <h3 class="text-lg font-semibold"></h3>
          <span class="badge"><span class="emoji">üó≥Ô∏è</span><span class="votes"></span></span>
        </div>
        <p class="text-sm text-slate-300 story"></p>
      </header>
      <div class="space-y-2 text-sm text-slate-400">
        <div class="progress-bar"><div class="sentiment" style="width:50%"></div></div>
        <p><strong class="text-slate-200">Public Mood:</strong> <span class="summary"></span></p>
        <p class="status text-xs uppercase tracking-wide text-slate-500"></p>
      </div>
      <footer class="flex items-center justify-between text-sm">
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded-full bg-slate-800 hover:bg-slate-700 vote-up">üëç</button>
          <button class="px-3 py-1 rounded-full bg-slate-800 hover:bg-slate-700 vote-down">üëé</button>
        </div>
        <a class="text-indigo-300 hover:text-indigo-200 text-sm" href="#">View Case ‚Üí</a>
      </footer>
    </article>
  </template>

  <script>
    const feed = document.getElementById('case-feed');
    const template = document.getElementById('case-template');
    const uploadForm = document.getElementById('upload-form');
    const runTrialButton = document.getElementById('run-trial');
    const trialMessage = document.getElementById('trial-message');

    async function fetchCases() {
      try {
        const response = await fetch('../data/cases.json?_=' + Date.now());
        if (!response.ok) throw new Error('Failed to fetch cases');
        const cases = await response.json();
        renderCases(cases);
      } catch (error) {
        console.error('Failed to load cases', error);
        feed.innerHTML = '<p class="text-sm text-rose-300">Unable to load the docket right now. Try again shortly.</p>';
      }
    }

    function renderCases(cases) {
      feed.innerHTML = '';
      if (!cases.length) {
        feed.innerHTML = '<p class="text-sm text-slate-300">No cases yet. Submit a dilemma to start the debate.</p>';
        return;
      }

      cases.forEach((item) => {
        const node = template.content.cloneNode(true);
        node.querySelector('h3').textContent = item.title;
        node.querySelector('.story').textContent = item.story;
        node.querySelector('.votes').textContent = item.votes;
        const summaryText = item.ai_summary ? item.ai_summary.split('\n')[0].replace(/^‚Ä¢\s*/, '') : 'Awaiting community input.';
        node.querySelector('.summary').textContent = summaryText;
        const status = node.querySelector('.status');
        if (item.status === 'judged') {
          const details = [item.verdict?.decision, item.verdict?.judge ? `Judge ${item.verdict.judge}` : null];
          if (Number.isFinite(item.finalScore)) {
            details.push(`Score ${item.finalScore}`);
          }
          status.textContent = details.filter(Boolean).join(' ‚Ä¢ ') || 'Verdict published';
        } else {
          status.textContent = 'Awaiting trial';
        }
        const sentiment = Math.max(0, Math.min(100, Math.round(((item.comments || []).reduce((acc, c) => acc + (c.sentiment || 0), 0) / Math.max(1, (item.comments || []).length) + 1) * 50)));
        node.querySelector('.sentiment').style.width = sentiment + '%';
        node.querySelector('a').href = `case.html?id=${encodeURIComponent(item.id)}`;
        node.querySelector('.vote-up').addEventListener('click', () => vote(item.id, 1));
        node.querySelector('.vote-down').addEventListener('click', () => vote(item.id, -1));
        feed.appendChild(node);
      });
    }

    async function triggerTrial() {
      if (!runTrialButton) return;
      runTrialButton.disabled = true;
      runTrialButton.textContent = 'Running‚Ä¶';
      if (trialMessage) {
        trialMessage.hidden = true;
      }
      try {
        const response = await fetch('/api/runTrial', { method: 'POST' });
        if (!response.ok) throw new Error('Trial failed');
        const result = await response.json();
        const processed = result.processed || [];
        if (trialMessage) {
          if (processed.length) {
            trialMessage.textContent = `Processed ${processed.length} case${processed.length > 1 ? 's' : ''}: ${processed.join(', ')}`;
          } else {
            trialMessage.textContent = 'No pending cases were ready for trial yet.';
          }
          trialMessage.hidden = false;
        }
        fetchCases();
      } catch (error) {
        console.error('Trial run failed', error);
        if (trialMessage) {
          trialMessage.textContent = 'Could not run the AI trial. Please try again.';
          trialMessage.hidden = false;
        }
      } finally {
        runTrialButton.disabled = false;
        runTrialButton.textContent = 'Run AI Trial';
      }
    }

    async function vote(id, delta) {
      try {
        await fetch('/api/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, delta })
        });
        fetchCases();
      } catch (error) {
        console.error('Vote failed', error);
      }
    }

    if (runTrialButton) {
      runTrialButton.addEventListener('click', triggerTrial);
    }

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(uploadForm);
      const payload = Object.fromEntries(formData.entries());
      try {
        await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        uploadForm.reset();
        fetchCases();
      } catch (error) {
        console.error('Upload failed', error);
      }
    });

    fetchCases();
  </script>
</body>
</html>
